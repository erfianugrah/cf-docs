<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Erfi Anugrah">
<meta name="dcterms.date" content="2024-05-24">

<title>How to: Get Up and Running with Magic WAN (+ its interops)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="magic-interop_files/libs/clipboard/clipboard.min.js"></script>
<script src="magic-interop_files/libs/quarto-html/quarto.js"></script>
<script src="magic-interop_files/libs/quarto-html/popper.min.js"></script>
<script src="magic-interop_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="magic-interop_files/libs/quarto-html/anchor.min.js"></script>
<link href="magic-interop_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="magic-interop_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="magic-interop_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="magic-interop_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="magic-interop_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<meta name="mermaid-theme" content="dark">
<script src="magic-interop_files/libs/quarto-diagram/mermaid.min.js"></script>
<script src="magic-interop_files/libs/quarto-diagram/mermaid-init.js"></script>
<link href="magic-interop_files/libs/quarto-diagram/mermaid.css" rel="stylesheet">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#step-1-conduit-configuration" id="toc-step-1-conduit-configuration" class="nav-link active" data-scroll-target="#step-1-conduit-configuration">Step 1: Conduit Configuration</a></li>
  <li><a href="#step-2-gre-andor-ipsec-tunnel-prerequisites" id="toc-step-2-gre-andor-ipsec-tunnel-prerequisites" class="nav-link" data-scroll-target="#step-2-gre-andor-ipsec-tunnel-prerequisites">Step 2: GRE and/or IPsec Tunnel Prerequisites</a></li>
  <li><a href="#step-3-configure-your-tunnels-and-static-routes-on-cloudflare" id="toc-step-3-configure-your-tunnels-and-static-routes-on-cloudflare" class="nav-link" data-scroll-target="#step-3-configure-your-tunnels-and-static-routes-on-cloudflare">Step 3: Configure your tunnels and static routes on Cloudflare</a></li>
  <li><a href="#step-4-make-sure-health-checks-work" id="toc-step-4-make-sure-health-checks-work" class="nav-link" data-scroll-target="#step-4-make-sure-health-checks-work">Step 4: Make sure health-checks work</a></li>
  <li><a href="#step-5-route-the-private-subnets-to-your-vti" id="toc-step-5-route-the-private-subnets-to-your-vti" class="nav-link" data-scroll-target="#step-5-route-the-private-subnets-to-your-vti">Step 5: Route the private subnets to your <code>vti</code></a></li>
  <li><a href="#step-6-automate-your-provisioning-through-the-use-of-gitopsiac" id="toc-step-6-automate-your-provisioning-through-the-use-of-gitopsiac" class="nav-link" data-scroll-target="#step-6-automate-your-provisioning-through-the-use-of-gitopsiac">Step 6: Automate your provisioning through the use of Gitops/IaC</a>
  <ul>
  <li><a href="#gre-tunnels" id="toc-gre-tunnels" class="nav-link" data-scroll-target="#gre-tunnels">GRE Tunnels</a></li>
  <li><a href="#ipsec-tunnels" id="toc-ipsec-tunnels" class="nav-link" data-scroll-target="#ipsec-tunnels">IPsec Tunnels</a></li>
  <li><a href="#static-routes" id="toc-static-routes" class="nav-link" data-scroll-target="#static-routes">Static Routes</a></li>
  <li><a href="#magic-firewall" id="toc-magic-firewall" class="nav-link" data-scroll-target="#magic-firewall">Magic Firewall</a></li>
  </ul></li>
  <li><a href="#step-7-interoperability-optional" id="toc-step-7-interoperability-optional" class="nav-link" data-scroll-target="#step-7-interoperability-optional">Step 7: Interoperability (Optional)</a>
  <ul>
  <li><a href="#pac-file-proxy-endpoints" id="toc-pac-file-proxy-endpoints" class="nav-link" data-scroll-target="#pac-file-proxy-endpoints">PAC File (Proxy Endpoints)</a>
  <ul>
  <li><a href="#pac-file-worker-deployment" id="toc-pac-file-worker-deployment" class="nav-link" data-scroll-target="#pac-file-worker-deployment">PAC File Worker Deployment</a>
  <ul>
  <li><a href="#worker-entrypoint-index.js" id="toc-worker-entrypoint-index.js" class="nav-link" data-scroll-target="#worker-entrypoint-index.js">Worker entrypoint (index.js)</a></li>
  <li><a href="#pac-file-variables-pac_file.js" id="toc-pac-file-variables-pac_file.js" class="nav-link" data-scroll-target="#pac-file-variables-pac_file.js">PAC File variables (pac_file.js)</a></li>
  <li><a href="#wrangler.toml" id="toc-wrangler.toml" class="nav-link" data-scroll-target="#wrangler.toml">wrangler.toml</a></li>
  </ul></li>
  <li><a href="#gitopsiac" id="toc-gitopsiac" class="nav-link" data-scroll-target="#gitopsiac">Gitops/IaC</a>
  <ul>
  <li><a href="#proxy-endpoints-hcl" id="toc-proxy-endpoints-hcl" class="nav-link" data-scroll-target="#proxy-endpoints-hcl">Proxy Endpoints HCL</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#warpclientless-rbi" id="toc-warpclientless-rbi" class="nav-link" data-scroll-target="#warpclientless-rbi">WARP/Clientless RBI</a>
  <ul>
  <li><a href="#gitopsiac-1" id="toc-gitopsiac-1" class="nav-link" data-scroll-target="#gitopsiac-1">Gitops/Iac</a>
  <ul>
  <li><a href="#warprbi-access-policy-hcl" id="toc-warprbi-access-policy-hcl" class="nav-link" data-scroll-target="#warprbi-access-policy-hcl">WARP/RBI Access Policy HCL</a></li>
  <li><a href="#warprbi-access-app-hcl" id="toc-warprbi-access-app-hcl" class="nav-link" data-scroll-target="#warprbi-access-app-hcl">WARP/RBI Access App HCL</a></li>
  <li><a href="#virtual-networks-hcl" id="toc-virtual-networks-hcl" class="nav-link" data-scroll-target="#virtual-networks-hcl">Virtual Networks HCL</a></li>
  <li><a href="#device-settings-policy-hcl" id="toc-device-settings-policy-hcl" class="nav-link" data-scroll-target="#device-settings-policy-hcl">Device Settings Policy HCL</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#cloudflare-tunnel" id="toc-cloudflare-tunnel" class="nav-link" data-scroll-target="#cloudflare-tunnel">Cloudflare Tunnel</a>
  <ul>
  <li><a href="#gitopsiac-2" id="toc-gitopsiac-2" class="nav-link" data-scroll-target="#gitopsiac-2">Gitops/IaC</a>
  <ul>
  <li><a href="#terraform-provider-hcl-with-random-provider" id="toc-terraform-provider-hcl-with-random-provider" class="nav-link" data-scroll-target="#terraform-provider-hcl-with-random-provider">Terraform provider HCL with random provider</a></li>
  <li><a href="#use-the-random-provider-to-generate-string-that-will-be-use-to-set-the-tunnel-secret" id="toc-use-the-random-provider-to-generate-string-that-will-be-use-to-set-the-tunnel-secret" class="nav-link" data-scroll-target="#use-the-random-provider-to-generate-string-that-will-be-use-to-set-the-tunnel-secret">Use the random provider to generate string that will be use to set the tunnel secret</a></li>
  <li><a href="#use-the-random-string-as-the-tunnel-secret-to-create-the-cloudflare-tunnel" id="toc-use-the-random-string-as-the-tunnel-secret-to-create-the-cloudflare-tunnel" class="nav-link" data-scroll-target="#use-the-random-string-as-the-tunnel-secret-to-create-the-cloudflare-tunnel">Use the random string as the tunnel secret to create the Cloudflare Tunnel</a></li>
  <li><a href="#tunnel-route-hcl" id="toc-tunnel-route-hcl" class="nav-link" data-scroll-target="#tunnel-route-hcl">Tunnel Route HCL</a></li>
  <li><a href="#tunnel-config-hcl" id="toc-tunnel-config-hcl" class="nav-link" data-scroll-target="#tunnel-config-hcl">Tunnel Config HCL</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#beta-warp-connector" id="toc-beta-warp-connector" class="nav-link" data-scroll-target="#beta-warp-connector">(Beta) WARP Connector</a>
  <ul>
  <li><a href="#site-to-site-connectivity" id="toc-site-to-site-connectivity" class="nav-link" data-scroll-target="#site-to-site-connectivity">Site-to-site Connectivity</a></li>
  </ul></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="magic-interop.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">How to: Get Up and Running with Magic WAN (+ its interops)</h1>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Erfi Anugrah <a href="mailto:erfi@cloudflare.com" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Cloudflare
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 24, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<div style="page-break-after: always;"></div>
<section id="step-1-conduit-configuration" class="level3">
<h3 class="anchored" data-anchor-id="step-1-conduit-configuration">Step 1: Conduit Configuration</h3>
<p>This would be setup during the onboarding with Cloudflare, the setup would require specific information from your end w.r.t specific subnets that should be upgraded or if you want to use non RFC 1918 prefixes.</p>
</section>
<section id="step-2-gre-andor-ipsec-tunnel-prerequisites" class="level3">
<h3 class="anchored" data-anchor-id="step-2-gre-andor-ipsec-tunnel-prerequisites">Step 2: GRE and/or IPsec Tunnel Prerequisites</h3>
<p>Both GRE and IPsec would add on top of the raw TCP packet, assuming MTU size being 1500 (this can be lower depending on your internet breakouts, KPN and Deutsch Telecom for instance would already need TCP clamping), the MSS would be lower:</p>
<p>For GRE:</p>
<table class="table">
<thead>
<tr class="header">
<th>Standard Internet Routable MTU</th>
<th>1500 bytes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>- Original IP header</td>
<td>20 bytes</td>
</tr>
<tr class="even">
<td>- Original protocol header (TCP)</td>
<td>20 bytes</td>
</tr>
<tr class="odd">
<td>- New IP header</td>
<td>20 bytes</td>
</tr>
<tr class="even">
<td>- New protocol header (GRE)</td>
<td>4 bytes</td>
</tr>
<tr class="odd">
<td>= Maximum segment size (MSS)</td>
<td>1436 bytes</td>
</tr>
</tbody>
</table>
<p>For IPsec this value would be lower still, depending on if it’s IPsec within GRE or on its own. The <code>ESP</code> header would be <code>8 bytes</code>, <code>ESP Trailer</code> could be <code>16 to 20 bytes</code> conservatively.</p>
<p>In my case the end value is <code>1350</code>.</p>
<p>You can check by running this command:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">sudo</span> tcpdump <span class="at">-i</span> <span class="pp">[</span><span class="ss">INTERFACE</span><span class="pp">]</span> <span class="st">'tcp[tcpflags] &amp; (tcp-syn)!=0 and dst port [443 or 80]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Or running with <code>do-not-fragment</code> and <code>size</code>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">sudo</span> ping IP <span class="at">-M</span> <span class="at">-s</span> 1500</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>An example would look like this for the internet breakout:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1"></a><span class="ex">09:47:29.132309</span> IP <span class="pp">[</span><span class="ss">MY_IP</span><span class="pp">]</span>.fixed.kpn.net.53958 <span class="op">&gt;</span> 162.159.138.105.https: Flags <span class="pp">[</span><span class="ss">S</span><span class="pp">]</span>, seq 471050517, win 64240, options [mss 1452,nop,wscale 8,nop,nop,sackOK], length 0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With IPsec, <code>10.68.100.20</code> is the tunnel endpoint on my side of the tunnel:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1"></a><span class="ex">09:49:19.268016</span> IP 10.68.100.20.51678 <span class="op">&gt;</span> 104.16.236.133.https: Flags <span class="pp">[</span><span class="ss">S</span><span class="pp">]</span>, seq 2995991175, win 32120, options [mss 1350,sackOK,TS val 1792385600 ecr 0,nop,wscale 7], length 0:</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-3-configure-your-tunnels-and-static-routes-on-cloudflare" class="level3">
<h3 class="anchored" data-anchor-id="step-3-configure-your-tunnels-and-static-routes-on-cloudflare">Step 3: Configure your <a href="https://developers.cloudflare.com/magic-wan/configuration/manually/how-to/configure-tunnels/">tunnels</a> and <a href="https://developers.cloudflare.com/magic-wan/configuration/manually/how-to/configure-static-routes/">static routes</a> on Cloudflare</h3>
<ul>
<li>Create a <a href="https://docs.strongswan.org/docs/5.9/features/routeBasedVpn.html#XFRM-Interfaces-on-Linux">vti</a> with a /31 subnet for use, refer to your vendor documentation on how to create one</li>
<li>The Cloudflare endpoint will be provided to you via the conduit configuration yaml</li>
<li>The Customer endpoint would be the IP provided to you via your ISP</li>
<li>By default, you can only add <a href="https://developers.cloudflare.com/magic-wan/configuration/manually/how-to/configure-static-routes/">static routes</a> with <a href="https://datatracker.ietf.org/doc/html/rfc1918">RFC 1918</a> IP prefixes like:
<ul>
<li>10.0.0.0/8</li>
<li>172.16.0.0/12</li>
<li>192.168.0.0/16</li>
</ul></li>
</ul>
<p>There are exceptions for publicly routable addresses, inform your friendly (at this point) implementation manager before the project begins.</p>
</section>
<section id="step-4-make-sure-health-checks-work" class="level3">
<h3 class="anchored" data-anchor-id="step-4-make-sure-health-checks-work">Step 4: Make sure <a href="https://developers.cloudflare.com/magic-wan/configuration/manually/how-to/tunnel-health-checks/">health-checks</a> work</h3>
<p>You should start seeing Cloudflare’s side of the tunnel hitting yours (health wise, take an average as not all data centers pinging your end of the tunnel matters):</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1"></a><span class="ex">10:05:07.160315</span> IP 10.68.100.21 <span class="op">&gt;</span> 10.68.100.20: ICMP echo request, id 7295, seq 0, length 64</span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="ex">10:05:07.160378</span> IP 10.68.100.20 <span class="op">&gt;</span> 10.68.100.21: ICMP echo reply, id 7295, seq 0, length 64</span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="ex">10:05:07.169088</span> IP 10.68.100.21 <span class="op">&gt;</span> 10.68.100.20: ICMP echo request, id 63043, seq 0, length 64</span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="ex">10:05:07.169150</span> IP 10.68.100.20 <span class="op">&gt;</span> 10.68.100.21: ICMP echo reply, id 63043, seq 0, length 64</span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="ex">10:05:07.208415</span> IP 10.68.100.21 <span class="op">&gt;</span> 10.68.100.20: ICMP echo request, id 41057, seq 0, length 64</span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="ex">10:05:07.208498</span> IP 10.68.100.20 <span class="op">&gt;</span> 10.68.100.21: ICMP echo reply, id 41057, seq 0, length 64</span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="ex">10:05:07.238198</span> IP 10.68.100.21 <span class="op">&gt;</span> 10.68.100.20: ICMP echo request, id 17771, seq 0, length 64</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If you have <code>replay-window</code> enabled, make sure <a href="https://developers.cloudflare.com/magic-wan/reference/anti-replay-protection/">anti-replay protection</a> is enabled on Cloudflare’s side.</p>
<div style="page-break-after: always;"></div>
</section>
<section id="step-5-route-the-private-subnets-to-your-vti" class="level3">
<h3 class="anchored" data-anchor-id="step-5-route-the-private-subnets-to-your-vti">Step 5: Route the private subnets to your <code>vti</code></h3>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Check your <code>sysctl</code> configuration for linux kernels.</p>
<p>It is possible that you might need to set these values:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1"></a><span class="fu">sudo</span> sysctl <span class="at">-w</span> net.ipv4.conf.all.accept_local=1</span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="fu">sudo</span> sysctl <span class="at">-w</span> net.ipv4.conf.all.rp_filter=0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>For rp_filter</code>:</p>
<ul>
<li>0 - No source validation.</li>
<li>1 - Strict mode as defined in RFC3704 Strict Reverse Path Each incoming packet is tested against the FIB and if the interface is not the best reverse path the packet check will fail. By default failed packets are discarded.</li>
<li>2 - Loose mode as defined in RFC3704 Loose Reverse Path Each incoming packet’s source address is also tested against the FIB and if the source address is not reachable via any interface the packet check will fail.</li>
</ul>
<p>Current recommended practice in RFC3704 is to enable strict mode to prevent IP spoofing from DDos attacks. <strong>If using asymmetric routing or other complicated routing, then loose mode is recommended.</strong></p>
</div>
</div>
<p>Consult your vendor documentation, here are some examples:</p>
<ul>
<li><a href="https://developers.cloudflare.com/magic-wan/configuration/manually/third-party/alibaba-cloud/">Alibaba Cloud VPN Gateway</a></li>
<li><a href="https://developers.cloudflare.com/magic-wan/configuration/manually/third-party/aws/">Amazon AWS Transit Gateway</a></li>
<li><a href="https://developers.cloudflare.com/magic-wan/configuration/manually/third-party/aruba-edgeconnect/">Aruba EdgeConnect Enterprise</a></li>
<li><a href="https://developers.cloudflare.com/magic-wan/configuration/manually/third-party/cisco-ios-xe/">Cisco IOS XE</a></li>
<li><a href="https://developers.cloudflare.com/magic-wan/configuration/manually/third-party/viptela/">Cisco SD-WAN</a></li>
<li><a href="https://developers.cloudflare.com/magic-wan/configuration/manually/third-party/fortinet/">Fortinet</a></li>
<li><a href="https://developers.cloudflare.com/magic-wan/configuration/manually/third-party/fitelnet/">Furukawa Electric FITELnet</a></li>
<li><a href="https://developers.cloudflare.com/magic-wan/configuration/manually/third-party/google/">Google Cloud VPN</a></li>
<li><a href="https://developers.cloudflare.com/magic-wan/configuration/manually/third-party/azure/">Microsoft Azure</a></li>
<li><a href="https://developers.cloudflare.com/magic-wan/configuration/manually/third-party/palo-alto/">Palo Alto Networks NGFW</a></li>
<li><a href="https://developers.cloudflare.com/magic-wan/configuration/manually/third-party/pfsense/">pfSense</a></li>
<li><a href="https://developers.cloudflare.com/magic-wan/configuration/manually/third-party/sonicwall/">SonicWall</a></li>
<li><a href="https://developers.cloudflare.com/magic-wan/configuration/manually/third-party/sophos-firewall/">Sophos Firewall</a></li>
<li><a href="https://developers.cloudflare.com/magic-wan/configuration/manually/third-party/strongswan/">strongSwan</a></li>
<li><a href="https://developers.cloudflare.com/magic-wan/configuration/manually/third-party/vyos/">VyOS</a></li>
</ul>
<p>You can do a TCP <code>traceroute</code> to see if it’s going via the tunnel to another endpoint that’s also exposed via Magic WAN:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1"></a><span class="fu">sudo</span> traceroute <span class="at">-T</span> 172.18.0.8</span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="ex">traceroute</span> to 172.18.0.8 <span class="er">(</span><span class="ex">172.18.0.8</span><span class="kw">)</span><span class="ex">,</span> 30 hops max, 60 byte packets</span>
<span id="cb7-3"><a href="#cb7-3"></a> <span class="ex">1</span>  10.68.69.1 <span class="er">(</span><span class="ex">10.68.69.1</span><span class="kw">)</span>  <span class="ex">0.627</span> ms  0.460 ms  0.480 ms</span>
<span id="cb7-4"><a href="#cb7-4"></a> <span class="ex">2</span>  10.68.100.21 <span class="er">(</span><span class="ex">10.68.100.21</span><span class="kw">)</span>  <span class="ex">5.833</span> ms  5.289 ms  5.264 ms</span>
<span id="cb7-5"><a href="#cb7-5"></a> <span class="ex">3</span>  172.71.93.32 <span class="er">(</span><span class="ex">172.71.93.32</span><span class="kw">)</span>  <span class="ex">7.644</span> ms  7.038 ms  10.645 ms</span>
<span id="cb7-6"><a href="#cb7-6"></a> <span class="ex">4</span>  172.18.0.8 <span class="er">(</span><span class="ex">172.18.0.8</span><span class="kw">)</span>  <span class="ex">10.356</span> ms  10.562 ms  10.244 ms</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div style="page-break-after: always;"></div>
</section>
<section id="step-6-automate-your-provisioning-through-the-use-of-gitopsiac" class="level3">
<h3 class="anchored" data-anchor-id="step-6-automate-your-provisioning-through-the-use-of-gitopsiac">Step 6: Automate your provisioning through the use of Gitops/IaC</h3>
<p>This can be done via the UI, API or via Terraform. However, it is recommended to use infrastructure as code as much as possible. The examples make use of <a href="https://developer.hashicorp.com/terraform/language/values/variables#variable-definitions-tfvars-files"><code>.tfvars</code></a> file and a <a href="https://developer.hashicorp.com/terraform/language/values/variables#declaring-an-input-variable"><code>variables.tf</code></a> file to reference those sensitive values when applying or planning the infrastructure with Terraform. There are many ways to go about securing the sensitive information including the <code>.tfstate</code> file such as encrypting with <a href="https://github.com/getsops/sops"><code>Mozilla SOPS</code></a> and <a href="https://github.com/FiloSottile/age"><code>Age</code></a>.</p>
<section id="gre-tunnels" class="level4">
<h4 class="anchored" data-anchor-id="gre-tunnels">GRE Tunnels</h4>
<div class="sourceCode" id="cb8"><pre class="sourceCode numberSource terraform number-lines code-with-copy"><code class="sourceCode"><span id="cb8-1"><a href="#cb8-1"></a>resource "cloudflare_gre_tunnel" "vyos_sg" {</span>
<span id="cb8-2"><a href="#cb8-2"></a>  account_id              = var.cloudflare_account_id</span>
<span id="cb8-3"><a href="#cb8-3"></a>  name                    = "vyos_sg"</span>
<span id="cb8-4"><a href="#cb8-4"></a>  customer_gre_endpoint   = var.sg_ip</span>
<span id="cb8-5"><a href="#cb8-5"></a>  cloudflare_gre_endpoint = var.wan_ip_1  # This will be provided to you during onboarding</span>
<span id="cb8-6"><a href="#cb8-6"></a>  interface_address       = "10.68.88.21/31"</span>
<span id="cb8-7"><a href="#cb8-7"></a>  description             = "vyos_sg_gre"</span>
<span id="cb8-8"><a href="#cb8-8"></a>  ttl                     = 64</span>
<span id="cb8-9"><a href="#cb8-9"></a>  mtu                     = 1476</span>
<span id="cb8-10"><a href="#cb8-10"></a>  health_check_enabled    = true</span>
<span id="cb8-11"><a href="#cb8-11"></a>  health_check_target     = var.sg_ip</span>
<span id="cb8-12"><a href="#cb8-12"></a>  health_check_type       = "request"</span>
<span id="cb8-13"><a href="#cb8-13"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="ipsec-tunnels" class="level4">
<h4 class="anchored" data-anchor-id="ipsec-tunnels">IPsec Tunnels</h4>
<div class="sourceCode" id="cb9"><pre class="sourceCode numberSource terraform number-lines code-with-copy"><code class="sourceCode"><span id="cb9-1"><a href="#cb9-1"></a>resource "cloudflare_ipsec_tunnel" "vyos_sg_ipsec" {</span>
<span id="cb9-2"><a href="#cb9-2"></a>  account_id           = var.cloudflare_account_id</span>
<span id="cb9-3"><a href="#cb9-3"></a>  name                 = "vyos_sg_ipsec"</span>
<span id="cb9-4"><a href="#cb9-4"></a>  customer_endpoint    = var.sg_ip</span>
<span id="cb9-5"><a href="#cb9-5"></a>  cloudflare_endpoint  = var.wan_ip_2</span>
<span id="cb9-6"><a href="#cb9-6"></a>  interface_address    = "10.68.77.21/31"</span>
<span id="cb9-7"><a href="#cb9-7"></a>  description          = "vyos_sg_ipsec_m1"</span>
<span id="cb9-8"><a href="#cb9-8"></a>  health_check_enabled = true</span>
<span id="cb9-9"><a href="#cb9-9"></a>  health_check_target  = var.sg_ip</span>
<span id="cb9-10"><a href="#cb9-10"></a>  health_check_type    = "request"</span>
<span id="cb9-11"><a href="#cb9-11"></a>  psk                  = var.psk_sg</span>
<span id="cb9-12"><a href="#cb9-12"></a>  allow_null_cipher    = false</span>
<span id="cb9-13"><a href="#cb9-13"></a>  hex_id               = var.hex_id_sg</span>
<span id="cb9-14"><a href="#cb9-14"></a>  fqdn_id              = var.fqdn_id_sg</span>
<span id="cb9-15"><a href="#cb9-15"></a>  user_id              = var.user_id_sg</span>
<span id="cb9-16"><a href="#cb9-16"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div style="page-break-after: always;"></div>
</section>
<section id="static-routes" class="level4">
<h4 class="anchored" data-anchor-id="static-routes">Static Routes</h4>
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource terraform number-lines code-with-copy"><code class="sourceCode"><span id="cb10-1"><a href="#cb10-1"></a>The `next-hop` address would be Cloudflare's side of the tunnel</span>
<span id="cb10-2"><a href="#cb10-2"></a>resource "cloudflare_static_route" "eth1_vyos_nl_ipsec" {</span>
<span id="cb10-3"><a href="#cb10-3"></a>  account_id  = var.cloudflare_account_id</span>
<span id="cb10-4"><a href="#cb10-4"></a>  description = "ETH1"</span>
<span id="cb10-5"><a href="#cb10-5"></a>  prefix      = "10.68.69.0/24"</span>
<span id="cb10-6"><a href="#cb10-6"></a>  nexthop     = "10.68.100.20"</span>
<span id="cb10-7"><a href="#cb10-7"></a>  priority    = 100</span>
<span id="cb10-8"><a href="#cb10-8"></a>}</span>
<span id="cb10-9"><a href="#cb10-9"></a>resource "cloudflare_static_route" "eth1_100_vyos_nl_ipsec" {</span>
<span id="cb10-10"><a href="#cb10-10"></a>  account_id  = var.cloudflare_account_id</span>
<span id="cb10-11"><a href="#cb10-11"></a>  description = "VLAN_100"</span>
<span id="cb10-12"><a href="#cb10-12"></a>  prefix      = "10.68.70.0/24"</span>
<span id="cb10-13"><a href="#cb10-13"></a>  nexthop     = "10.68.100.20"</span>
<span id="cb10-14"><a href="#cb10-14"></a>  priority    = 100</span>
<span id="cb10-15"><a href="#cb10-15"></a>}</span>
<span id="cb10-16"><a href="#cb10-16"></a> </span>
<span id="cb10-17"><a href="#cb10-17"></a>resource "cloudflare_static_route" "podman_vyos_nl_ipsec" {</span>
<span id="cb10-18"><a href="#cb10-18"></a>  account_id  = var.cloudflare_account_id</span>
<span id="cb10-19"><a href="#cb10-19"></a>  description = "Podman"</span>
<span id="cb10-20"><a href="#cb10-20"></a>  prefix      = "172.18.0.0/16"</span>
<span id="cb10-21"><a href="#cb10-21"></a>  nexthop     = "10.68.100.20"</span>
<span id="cb10-22"><a href="#cb10-22"></a>  priority    = 100</span>
<span id="cb10-23"><a href="#cb10-23"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div style="page-break-after: always;"></div>
</section>
<section id="magic-firewall" class="level4">
<h4 class="anchored" data-anchor-id="magic-firewall">Magic Firewall</h4>
<p>Refer also to <a href="https://developers.cloudflare.com/magic-firewall/best-practices/">example rulesets</a> based on common attack vectors</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode numberSource terraform number-lines code-with-copy"><code class="sourceCode"><span id="cb11-1"><a href="#cb11-1"></a>resource "cloudflare_magic_firewall_ruleset" "magic_firewall" {</span>
<span id="cb11-2"><a href="#cb11-2"></a>  account_id  = var.cloudflare_account_id</span>
<span id="cb11-3"><a href="#cb11-3"></a>  name        = "Magic WAN Firewall"</span>
<span id="cb11-4"><a href="#cb11-4"></a>  description = "Default Magic WAN Firewall"</span>
<span id="cb11-5"><a href="#cb11-5"></a> </span>
<span id="cb11-6"><a href="#cb11-6"></a>  rules = [</span>
<span id="cb11-7"><a href="#cb11-7"></a>    {</span>
<span id="cb11-8"><a href="#cb11-8"></a>      action      = "allow"</span>
<span id="cb11-9"><a href="#cb11-9"></a>      expression  = "(ip.proto eq \"icmp\")"</span>
<span id="cb11-10"><a href="#cb11-10"></a>      description = "Allow ICMP"</span>
<span id="cb11-11"><a href="#cb11-11"></a>      enabled     = "true"</span>
<span id="cb11-12"><a href="#cb11-12"></a>    },</span>
<span id="cb11-13"><a href="#cb11-13"></a>    {</span>
<span id="cb11-14"><a href="#cb11-14"></a>      action      = "allow"</span>
<span id="cb11-15"><a href="#cb11-15"></a>      expression  = "(ip.src in {100.64.0.0/10})"</span>
<span id="cb11-16"><a href="#cb11-16"></a>      description = "Allow WARP Virtual IPs"</span>
<span id="cb11-17"><a href="#cb11-17"></a>      enabled     = "true"</span>
<span id="cb11-18"><a href="#cb11-18"></a>    }</span>
<span id="cb11-19"><a href="#cb11-19"></a>  ]</span>
<span id="cb11-20"><a href="#cb11-20"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div style="page-break-after: always;"></div>
</section>
</section>
<section id="step-7-interoperability-optional" class="level3">
<h3 class="anchored" data-anchor-id="step-7-interoperability-optional">Step 7: Interoperability (Optional)</h3>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Be aware of these limitations</strong></p>
<p><strong>Virtual Networks</strong></p>
<ul>
<li>Ensure Cloudflare Tunnel and WARP are on the default network for the interoperability to function</li>
</ul>
<p><strong>DH Group for IPsec Tunnels</strong></p>
<ul>
<li>Cloudflare supports DH groups 20, 14, 5, but only one should be used when creating tunnels</li>
</ul>
<p><strong>WARP w/ Magic WAN</strong></p>
<ul>
<li>Ensure WARP connectivity in locations whereby connectivity is routed to Cloudflare Gateway via Magic WAN to be excluded. This is due to the double encapsulation, once by WARP, and again via Magic WAN. Routing policies can be used to exclude connections to the <a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-devices/warp/deployment/firewall/#warp-ingress-ip">WARP Ingress IPs</a> and <a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-devices/warp/deployment/firewall/#warp-udp-ports">WARP UDP Ports</a></li>
</ul>
<p><strong>Cloudflare Tunnel w/ Magic WAN</strong></p>
<ul>
<li>Cloudflare Tunnel does not support outbound connections. Overlapping routes between Cloudflare Tunnel and Magic WAN will cause issues with outbound connections since Cloudflare Tunnel routes are prioritized over Magic WAN static routes</li>
</ul>
<p><strong>WARP Connector w/ Magic WAN</strong></p>
<ul>
<li>The WARP Connector solves the bi-directional use case that Cloudflare Tunnel doesn’t solve, however at this point, does not work with Magic WAN when configured within the same Cloudflare account/organisation (as the conduit configuration is tied to the account), and should be used as an alternative (as there are overlapping use cases) if the traditional approach via Magic WAN does not suit your current infrastructure.</li>
</ul>
</div>
</div>
<div class="cell" data-fig-width="6.5" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {'theme': 'dark','themeVariables': { 'lineColor': '#F8B229', 'backgroundColor': 'transparent'} }}%%
graph LR;
  classDef cloudflare fill:#FFA500,stroke:#333,stroke-width:2px,color:#000000;
  subgraph Cloudflare
    K{Cloudflare}
    L{Cloudflare} 
  class K,L cloudflare
  end
  subgraph Users
    M[PAC File User] --&gt; |HTTP| K
    M --&gt; |HTTP| L
    N[Clientless RBI User] --&gt; |HTTP| K
    N --&gt; |HTTP| L
    F[Magic WAN User] --&gt; |GRE or IPsec| K
    A[WARP User] --&gt; |QUIC or Wireguard| K
    A --&gt; |QUIC or Wireguard| L
  end
  subgraph WARP Connector   
    L --&gt;|QUIC or Wireguard| H[WARP Connector] &lt;--&gt; I[Private Service - VOIP]   
  end
  subgraph Magic WAN
    K --&gt; |GRE or IPsec| D[Magic WAN] &lt;--&gt; E[Private Service - File Server] 
  end
  subgraph Magic WAN Connector
    K --&gt; |GRE or IPsec| G[Magic WAN Connector] &lt;--&gt; J[SSH Server]
  end
  subgraph Cloudflare Tunnel
    K --&gt; |QUIC or H2| B[Cloudflare Tunnel] --&gt; C[Private Service - CRM] 
  end
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<div style="page-break-after: always;"></div>
<section id="pac-file-proxy-endpoints" class="level4">
<h4 class="anchored" data-anchor-id="pac-file-proxy-endpoints">PAC File (Proxy Endpoints)</h4>
<p>There are many ways to deploy the PAC file such as MDMs and using a remote server, in this case, I’ll be using <a href="https://github.com/erfianugrah/worker-proxy-pac">Workers</a>. You can follow the steps <a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-devices/agentless/pac-files/">here</a>, when using the code, you can create more cases to match specific files, in my case it is nl.pac and sg.pac to simulate the two locations, I also used <a href="https://developers.cloudflare.com/workers/configuration/secrets/">Workers Secrets</a> to store the Proxy Endpoint domains:</p>
<section id="pac-file-worker-deployment" class="level5">
<h5 class="anchored" data-anchor-id="pac-file-worker-deployment">PAC File Worker Deployment</h5>
<section id="worker-entrypoint-index.js" class="level6">
<h6 class="anchored" data-anchor-id="worker-entrypoint-index.js">Worker entrypoint (index.js)</h6>
<div class="sourceCode" id="cb12"><pre class="sourceCode numberSource js number-lines code-with-copy"><code class="sourceCode javascript"><span id="cb12-1"><a href="#cb12-1"></a><span class="im">import</span> { nl_pac_file<span class="op">,</span> sg_pac_file } <span class="im">from</span> <span class="st">"./pac_file.js"</span><span class="op">;</span></span>
<span id="cb12-2"><a href="#cb12-2"></a> </span>
<span id="cb12-3"><a href="#cb12-3"></a><span class="im">export</span> <span class="im">default</span> {</span>
<span id="cb12-4"><a href="#cb12-4"></a>  <span class="fu">fetch</span>(request<span class="op">,</span> env) {</span>
<span id="cb12-5"><a href="#cb12-5"></a>    <span class="kw">const</span> url <span class="op">=</span> <span class="kw">new</span> <span class="fu">URL</span>(request<span class="op">.</span><span class="at">url</span>)<span class="op">;</span></span>
<span id="cb12-6"><a href="#cb12-6"></a> </span>
<span id="cb12-7"><a href="#cb12-7"></a>    <span class="cf">if</span> (url<span class="op">.</span><span class="at">pathname</span> <span class="op">===</span> <span class="st">"/nl.pac"</span>) {</span>
<span id="cb12-8"><a href="#cb12-8"></a>      <span class="cf">return</span> <span class="fu">nl_pac_file</span>(env)<span class="op">;</span></span>
<span id="cb12-9"><a href="#cb12-9"></a>    } <span class="cf">else</span> <span class="cf">if</span> (url<span class="op">.</span><span class="at">pathname</span> <span class="op">===</span> <span class="st">"/sg.pac"</span>) {</span>
<span id="cb12-10"><a href="#cb12-10"></a>      <span class="cf">return</span> <span class="fu">sg_pac_file</span>(env)<span class="op">;</span></span>
<span id="cb12-11"><a href="#cb12-11"></a>    } <span class="cf">else</span> {</span>
<span id="cb12-12"><a href="#cb12-12"></a>      <span class="cf">return</span> <span class="kw">new</span> <span class="fu">Response</span>(<span class="st">"Not Found"</span><span class="op">,</span> { <span class="dt">status</span><span class="op">:</span> <span class="dv">404</span> })<span class="op">;</span></span>
<span id="cb12-13"><a href="#cb12-13"></a>    }</span>
<span id="cb12-14"><a href="#cb12-14"></a>  }<span class="op">,</span></span>
<span id="cb12-15"><a href="#cb12-15"></a>}<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div style="page-break-after: always;"></div>
</section>
<section id="pac-file-variables-pac_file.js" class="level6">
<h6 class="anchored" data-anchor-id="pac-file-variables-pac_file.js">PAC File variables (pac_file.js)</h6>
<div class="sourceCode" id="cb13"><pre class="sourceCode numberSource js number-lines code-with-copy"><code class="sourceCode javascript"><span id="cb13-1"><a href="#cb13-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">nl_pac_file</span>(env) {</span>
<span id="cb13-2"><a href="#cb13-2"></a>  <span class="kw">const</span> nl <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="vs">function FindProxyForURL(url, host) {</span></span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="vs">// No proxy for private (RFC 1918) IP addresses (intranet sites)</span></span>
<span id="cb13-5"><a href="#cb13-5"></a><span class="vs">  // if (</span></span>
<span id="cb13-6"><a href="#cb13-6"></a><span class="vs">  //   isInNet(dnsResolve(host), "10.0.0.0", "255.0.0.0") ||</span></span>
<span id="cb13-7"><a href="#cb13-7"></a><span class="vs">  //   isInNet(dnsResolve(host), "172.16.0.0", "255.240.0.0") ||</span></span>
<span id="cb13-8"><a href="#cb13-8"></a><span class="vs">  //   isInNet(dnsResolve(host), "192.168.0.0", "255.255.0.0")</span></span>
<span id="cb13-9"><a href="#cb13-9"></a><span class="vs">  // ) {</span></span>
<span id="cb13-10"><a href="#cb13-10"></a><span class="vs">  //   return "DIRECT";</span></span>
<span id="cb13-11"><a href="#cb13-11"></a><span class="vs">  // }</span></span>
<span id="cb13-12"><a href="#cb13-12"></a><span class="vs"> </span></span>
<span id="cb13-13"><a href="#cb13-13"></a><span class="vs">  // No proxy for localhost</span></span>
<span id="cb13-14"><a href="#cb13-14"></a><span class="vs">  // if (isInNet(dnsResolve(host), "127.0.0.0", "255.0.0.0")) {</span></span>
<span id="cb13-15"><a href="#cb13-15"></a><span class="vs">  //   return "DIRECT";</span></span>
<span id="cb13-16"><a href="#cb13-16"></a><span class="vs">  // }</span></span>
<span id="cb13-17"><a href="#cb13-17"></a><span class="vs">  // Example logic to determine whether to use a proxy</span></span>
<span id="cb13-18"><a href="#cb13-18"></a><span class="vs">  return "HTTPS </span><span class="sc">${</span>env<span class="op">.</span><span class="at">NL_DOMAIN</span><span class="sc">}</span><span class="vs">.proxy.cloudflare-gateway.com:443";</span></span>
<span id="cb13-19"><a href="#cb13-19"></a><span class="vs">}</span></span>
<span id="cb13-20"><a href="#cb13-20"></a><span class="vs">`</span><span class="op">;</span></span>
<span id="cb13-21"><a href="#cb13-21"></a>  <span class="co">// Set headers to prevent caching</span></span>
<span id="cb13-22"><a href="#cb13-22"></a>  <span class="kw">const</span> headers <span class="op">=</span> <span class="kw">new</span> <span class="fu">Headers</span>({</span>
<span id="cb13-23"><a href="#cb13-23"></a>    <span class="st">"Content-Type"</span><span class="op">:</span> <span class="st">"application/x-ns-proxy-auto-config"</span><span class="op">,</span></span>
<span id="cb13-24"><a href="#cb13-24"></a>    <span class="st">"Cache-Control"</span><span class="op">:</span> <span class="st">"no-store, max-age=0"</span><span class="op">,</span></span>
<span id="cb13-25"><a href="#cb13-25"></a>  })<span class="op">;</span></span>
<span id="cb13-26"><a href="#cb13-26"></a> </span>
<span id="cb13-27"><a href="#cb13-27"></a>  <span class="cf">return</span> <span class="kw">new</span> <span class="fu">Response</span>(nl<span class="op">,</span> { <span class="dt">headers</span><span class="op">:</span> headers })<span class="op">;</span></span>
<span id="cb13-28"><a href="#cb13-28"></a>}</span>
<span id="cb13-29"><a href="#cb13-29"></a></span>
<span id="cb13-30"><a href="#cb13-30"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">sg_pac_file</span>(env) {</span>
<span id="cb13-31"><a href="#cb13-31"></a>  <span class="kw">const</span> sg <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb13-32"><a href="#cb13-32"></a><span class="vs">function FindProxyForURL(url, host) {</span></span>
<span id="cb13-33"><a href="#cb13-33"></a><span class="vs">// No proxy for private (RFC 1918) IP addresses (intranet sites)</span></span>
<span id="cb13-34"><a href="#cb13-34"></a><span class="vs">  // if (</span></span>
<span id="cb13-35"><a href="#cb13-35"></a><span class="vs">  //   isInNet(dnsResolve(host), "10.0.0.0", "255.0.0.0") ||</span></span>
<span id="cb13-36"><a href="#cb13-36"></a><span class="vs">  //   isInNet(dnsResolve(host), "172.16.0.0", "255.240.0.0") ||</span></span>
<span id="cb13-37"><a href="#cb13-37"></a><span class="vs">  //   isInNet(dnsResolve(host), "192.168.0.0", "255.255.0.0")</span></span>
<span id="cb13-38"><a href="#cb13-38"></a><span class="vs">  // ) {</span></span>
<span id="cb13-39"><a href="#cb13-39"></a><span class="vs">  //   return "DIRECT";</span></span>
<span id="cb13-40"><a href="#cb13-40"></a><span class="vs">  // }</span></span>
<span id="cb13-41"><a href="#cb13-41"></a><span class="vs"> </span></span>
<span id="cb13-42"><a href="#cb13-42"></a><span class="vs">  // No proxy for localhost</span></span>
<span id="cb13-43"><a href="#cb13-43"></a><span class="vs">  // if (isInNet(dnsResolve(host), "127.0.0.0", "255.0.0.0")) {</span></span>
<span id="cb13-44"><a href="#cb13-44"></a><span class="vs">  //   return "DIRECT";</span></span>
<span id="cb13-45"><a href="#cb13-45"></a><span class="vs">  // }</span></span>
<span id="cb13-46"><a href="#cb13-46"></a><span class="vs">  // Example logic to determine whether to use a proxy</span></span>
<span id="cb13-47"><a href="#cb13-47"></a><span class="vs">  return "HTTPS </span><span class="sc">${</span>env<span class="op">.</span><span class="at">SG_DOMAIN</span><span class="sc">}</span><span class="vs">.proxy.cloudflare-gateway.com:443";</span></span>
<span id="cb13-48"><a href="#cb13-48"></a><span class="vs">}</span></span>
<span id="cb13-49"><a href="#cb13-49"></a><span class="vs">`</span><span class="op">;</span></span>
<span id="cb13-50"><a href="#cb13-50"></a>  <span class="co">// Set headers to prevent caching</span></span>
<span id="cb13-51"><a href="#cb13-51"></a>  <span class="kw">const</span> headers <span class="op">=</span> <span class="kw">new</span> <span class="fu">Headers</span>({</span>
<span id="cb13-52"><a href="#cb13-52"></a>    <span class="st">"Content-Type"</span><span class="op">:</span> <span class="st">"application/x-ns-proxy-auto-config"</span><span class="op">,</span></span>
<span id="cb13-53"><a href="#cb13-53"></a>    <span class="st">"Cache-Control"</span><span class="op">:</span> <span class="st">"no-store, max-age=0"</span><span class="op">,</span></span>
<span id="cb13-54"><a href="#cb13-54"></a>  })<span class="op">;</span></span>
<span id="cb13-55"><a href="#cb13-55"></a> </span>
<span id="cb13-56"><a href="#cb13-56"></a>  <span class="cf">return</span> <span class="kw">new</span> <span class="fu">Response</span>(sg<span class="op">,</span> { <span class="dt">headers</span><span class="op">:</span> headers })<span class="op">;</span></span>
<span id="cb13-57"><a href="#cb13-57"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div style="page-break-after: always;"></div>
</section>
<section id="wrangler.toml" class="level6">
<h6 class="anchored" data-anchor-id="wrangler.toml">wrangler.toml</h6>
<div class="sourceCode" id="cb14"><pre class="sourceCode numberSource toml number-lines code-with-copy"><code class="sourceCode toml"><span id="cb14-1"><a href="#cb14-1"></a><span class="dt">name</span> <span class="op">=</span> <span class="st">"worker-proxy-pac"</span></span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="dt">main</span> <span class="op">=</span> <span class="st">"src/index.js"</span></span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="dt">compatibility_date</span> <span class="op">=</span> <span class="st">"2024-05-12"</span></span>
<span id="cb14-4"><a href="#cb14-4"></a><span class="dt">compatibility_flags</span> <span class="op">=</span> <span class="op">[</span><span class="st">"nodejs_compat"</span><span class="op">]</span></span>
<span id="cb14-5"><a href="#cb14-5"></a> </span>
<span id="cb14-6"><a href="#cb14-6"></a><span class="kw">[dev]</span></span>
<span id="cb14-7"><a href="#cb14-7"></a><span class="dt">port</span> <span class="op">=</span> <span class="dv">9001</span></span>
<span id="cb14-8"><a href="#cb14-8"></a><span class="dt">local_protocol</span><span class="op">=</span><span class="st">"http"</span></span>
<span id="cb14-9"><a href="#cb14-9"></a><span class="dt">upstream_protocol</span><span class="op">=</span><span class="st">"https"</span></span>
<span id="cb14-10"><a href="#cb14-10"></a> </span>
<span id="cb14-11"><a href="#cb14-11"></a><span class="kw">[env.staging]</span></span>
<span id="cb14-12"><a href="#cb14-12"></a><span class="dt">name</span> <span class="op">=</span> <span class="st">"staging-pac"</span></span>
<span id="cb14-13"><a href="#cb14-13"></a><span class="dt">vars</span> <span class="op">=</span> <span class="op">{ </span><span class="dt">ENVIRONMENT</span><span class="op"> =</span> <span class="st">"staging"</span><span class="op"> }</span></span>
<span id="cb14-14"><a href="#cb14-14"></a><span class="dt">workers_dev</span> <span class="op">=</span> <span class="cn">true</span></span>
<span id="cb14-15"><a href="#cb14-15"></a> </span>
<span id="cb14-16"><a href="#cb14-16"></a><span class="kw">[env.prod]</span></span>
<span id="cb14-17"><a href="#cb14-17"></a><span class="dt">name</span> <span class="op">=</span> <span class="st">"prod-pac"</span></span>
<span id="cb14-18"><a href="#cb14-18"></a><span class="dt">vars</span> <span class="op">=</span> <span class="op">{ </span><span class="dt">ENVIRONMENT</span><span class="op"> =</span> <span class="st">"production"</span><span class="op"> }</span></span>
<span id="cb14-19"><a href="#cb14-19"></a><span class="dt">routes</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb14-20"><a href="#cb14-20"></a>    <span class="op">{ </span><span class="dt">pattern</span><span class="op"> =</span> <span class="st">"proxy.{DOMAIN}.com"</span><span class="op">, </span><span class="dt">custom_domain</span><span class="op"> =</span> <span class="cn">true</span><span class="op"> },</span></span>
<span id="cb14-21"><a href="#cb14-21"></a><span class="op">]</span></span>
<span id="cb14-22"><a href="#cb14-22"></a><span class="co"># Secrets</span></span>
<span id="cb14-23"><a href="#cb14-23"></a><span class="co"># NL_DOMAIN</span></span>
<span id="cb14-24"><a href="#cb14-24"></a><span class="co"># SG_DOMAIN</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div style="page-break-after: always;"></div>
</section>
</section>
<section id="gitopsiac" class="level5">
<h5 class="anchored" data-anchor-id="gitopsiac">Gitops/IaC</h5>
<section id="proxy-endpoints-hcl" class="level6">
<h6 class="anchored" data-anchor-id="proxy-endpoints-hcl">Proxy Endpoints HCL</h6>
<div class="sourceCode" id="cb15"><pre class="sourceCode numberSource terraform number-lines code-with-copy"><code class="sourceCode"><span id="cb15-1"><a href="#cb15-1"></a>resource "cloudflare_teams_proxy_endpoint" "nl_proxy_endpoint" {</span>
<span id="cb15-2"><a href="#cb15-2"></a>  account_id = var.cloudflare_account_id</span>
<span id="cb15-3"><a href="#cb15-3"></a>  name       = "nl"</span>
<span id="cb15-4"><a href="#cb15-4"></a>  ips        = ["${var.nl_ip}/32"]</span>
<span id="cb15-5"><a href="#cb15-5"></a>}</span>
<span id="cb15-6"><a href="#cb15-6"></a> </span>
<span id="cb15-7"><a href="#cb15-7"></a>resource "cloudflare_teams_proxy_endpoint" "sg_proxy_endpoint" {</span>
<span id="cb15-8"><a href="#cb15-8"></a>  account_id = var.cloudflare_account_id</span>
<span id="cb15-9"><a href="#cb15-9"></a>  name       = "sg"</span>
<span id="cb15-10"><a href="#cb15-10"></a>  ips        = ["${var.sg_ip}/32"]</span>
<span id="cb15-11"><a href="#cb15-11"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
</section>
<section id="warpclientless-rbi" class="level4">
<h4 class="anchored" data-anchor-id="warpclientless-rbi">WARP/Clientless RBI</h4>
<p>With WARP, the <a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-devices/warp/deployment/mdm-deployment/">managed</a> deployment approach is recommended as you can ensure that not only you’re managing the devices and the policies but also the WARP client itself. This can also be managed through the use of <a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-devices/warp/configure-warp/device-profiles/">Device Profiles</a>. If the use case is to connect to endpoints behind Cloudflare Tunnel or Magic WAN, select the <code>default</code> <a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/private-net/cloudflared/tunnel-virtual-networks/">Virtual Network</a> in the client’s dropdown menu.</p>
<p>Both WARP (you can also isolate applications) and <a href="https://developers.cloudflare.com/cloudflare-one/policies/browser-isolation/setup/clientless-browser-isolation/#clientless-web-isolation">Clientless RBI</a> would use the same Access application and policy as shown below, and both would allow the user to access private IP applications via the other on-ramps.</p>
<section id="gitopsiac-1" class="level5">
<h5 class="anchored" data-anchor-id="gitopsiac-1">Gitops/Iac</h5>
<section id="warprbi-access-policy-hcl" class="level6">
<h6 class="anchored" data-anchor-id="warprbi-access-policy-hcl">WARP/RBI Access Policy HCL</h6>
<div class="sourceCode" id="cb16"><pre class="sourceCode numberSource terraform number-lines code-with-copy"><code class="sourceCode"><span id="cb16-1"><a href="#cb16-1"></a>resource "cloudflare_access_policy" "warp_login" {</span>
<span id="cb16-2"><a href="#cb16-2"></a>  account_id       = var.cloudflare_account_id</span>
<span id="cb16-3"><a href="#cb16-3"></a>  name             = "Allow Erfi"</span>
<span id="cb16-4"><a href="#cb16-4"></a>  decision         = "allow"</span>
<span id="cb16-5"><a href="#cb16-5"></a>  session_duration = "30m"</span>
<span id="cb16-6"><a href="#cb16-6"></a> </span>
<span id="cb16-7"><a href="#cb16-7"></a>  include {</span>
<span id="cb16-8"><a href="#cb16-8"></a>    group = [cloudflare_access_group.erfi_corp.id]</span>
<span id="cb16-9"><a href="#cb16-9"></a>  }</span>
<span id="cb16-10"><a href="#cb16-10"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div style="page-break-after: always;"></div>
</section>
<section id="warprbi-access-app-hcl" class="level6">
<h6 class="anchored" data-anchor-id="warprbi-access-app-hcl">WARP/RBI Access App HCL</h6>
<div class="sourceCode" id="cb17"><pre class="sourceCode numberSource terraform number-lines code-with-copy"><code class="sourceCode"><span id="cb17-1"><a href="#cb17-1"></a>resource "cloudflare_access_application" "warp_login" {</span>
<span id="cb17-2"><a href="#cb17-2"></a>  account_id = var.cloudflare_account_id</span>
<span id="cb17-3"><a href="#cb17-3"></a>  policies = [</span>
<span id="cb17-4"><a href="#cb17-4"></a>    cloudflare_access_policy.warp_login.id</span>
<span id="cb17-5"><a href="#cb17-5"></a>  ]</span>
<span id="cb17-6"><a href="#cb17-6"></a>  allowed_idps = [</span>
<span id="cb17-7"><a href="#cb17-7"></a>    cloudflare_access_identity_provider.entra_id.id,</span>
<span id="cb17-8"><a href="#cb17-8"></a>    cloudflare_access_identity_provider.google_workspace.id,</span>
<span id="cb17-9"><a href="#cb17-9"></a>    cloudflare_access_identity_provider.gmail.id,</span>
<span id="cb17-10"><a href="#cb17-10"></a>    cloudflare_access_identity_provider.keycloak_oidc.id,</span>
<span id="cb17-11"><a href="#cb17-11"></a>    cloudflare_access_identity_provider.authentik_oidc.id,</span>
<span id="cb17-12"><a href="#cb17-12"></a>    cloudflare_access_identity_provider.authentik_saml.id,</span>
<span id="cb17-13"><a href="#cb17-13"></a>    cloudflare_access_identity_provider.otp.id</span>
<span id="cb17-14"><a href="#cb17-14"></a>  ]</span>
<span id="cb17-15"><a href="#cb17-15"></a>  auto_redirect_to_identity = false</span>
<span id="cb17-16"><a href="#cb17-16"></a>  domain                    = "erfianugrah.cloudflareaccess.com/warp"</span>
<span id="cb17-17"><a href="#cb17-17"></a>  name                      = "Warp Login App"</span>
<span id="cb17-18"><a href="#cb17-18"></a>  session_duration          = "24h"</span>
<span id="cb17-19"><a href="#cb17-19"></a>  type                      = "warp"</span>
<span id="cb17-20"><a href="#cb17-20"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="virtual-networks-hcl" class="level6">
<h6 class="anchored" data-anchor-id="virtual-networks-hcl">Virtual Networks HCL</h6>
<div class="sourceCode" id="cb18"><pre class="sourceCode numberSource terraform number-lines code-with-copy"><code class="sourceCode"><span id="cb18-1"><a href="#cb18-1"></a>resource "cloudflare_tunnel_virtual_network" "vyos_nl" {</span>
<span id="cb18-2"><a href="#cb18-2"></a>  account_id = var.cloudflare_account_id</span>
<span id="cb18-3"><a href="#cb18-3"></a>  name       = "vyos_nl_vnet"</span>
<span id="cb18-4"><a href="#cb18-4"></a>  is_default_network = true</span>
<span id="cb18-5"><a href="#cb18-5"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div style="page-break-after: always;"></div>
</section>
<section id="device-settings-policy-hcl" class="level6">
<h6 class="anchored" data-anchor-id="device-settings-policy-hcl">Device Settings Policy HCL</h6>
<div class="sourceCode" id="cb19"><pre class="sourceCode numberSource terraform number-lines code-with-copy"><code class="sourceCode"><span id="cb19-1"><a href="#cb19-1"></a>resource "cloudflare_device_settings_policy" "default" {</span>
<span id="cb19-2"><a href="#cb19-2"></a>  account_id            = var.cloudflare_account_id</span>
<span id="cb19-3"><a href="#cb19-3"></a>  name                  = "default"</span>
<span id="cb19-4"><a href="#cb19-4"></a>  description           = "default_policy"</span>
<span id="cb19-5"><a href="#cb19-5"></a>  # precedence            = 100</span>
<span id="cb19-6"><a href="#cb19-6"></a>  # match                 = "any(identity.groups.name[*] in {\"Erfi Corp\"})"</span>
<span id="cb19-7"><a href="#cb19-7"></a>  default               = true</span>
<span id="cb19-8"><a href="#cb19-8"></a>  enabled               = true</span>
<span id="cb19-9"><a href="#cb19-9"></a>  allow_mode_switch     = true</span>
<span id="cb19-10"><a href="#cb19-10"></a>  allow_updates         = true</span>
<span id="cb19-11"><a href="#cb19-11"></a>  allowed_to_leave      = true</span>
<span id="cb19-12"><a href="#cb19-12"></a>  auto_connect          = 0</span>
<span id="cb19-13"><a href="#cb19-13"></a>  captive_portal        = 180</span>
<span id="cb19-14"><a href="#cb19-14"></a>  disable_auto_fallback = false</span>
<span id="cb19-15"><a href="#cb19-15"></a>  switch_locked         = false</span>
<span id="cb19-16"><a href="#cb19-16"></a>  service_mode_v2_mode  = "warp"</span>
<span id="cb19-17"><a href="#cb19-17"></a>  service_mode_v2_port  = 3000</span>
<span id="cb19-18"><a href="#cb19-18"></a>  exclude_office_ips    = true</span>
<span id="cb19-19"><a href="#cb19-19"></a>}</span>
<span id="cb19-20"><a href="#cb19-20"></a> </span>
<span id="cb19-21"><a href="#cb19-21"></a>resource "cloudflare_device_settings_policy" "google" {</span>
<span id="cb19-22"><a href="#cb19-22"></a>  account_id            = var.cloudflare_account_id</span>
<span id="cb19-23"><a href="#cb19-23"></a>  name                  = "Google Workspace"</span>
<span id="cb19-24"><a href="#cb19-24"></a>  description           = "google_workspace_policy"</span>
<span id="cb19-25"><a href="#cb19-25"></a>  precedence            = 200</span>
<span id="cb19-26"><a href="#cb19-26"></a>  match                 = "any(identity.groups.name[*] in {\"Erfi Corp\"})"</span>
<span id="cb19-27"><a href="#cb19-27"></a>  default               = false</span>
<span id="cb19-28"><a href="#cb19-28"></a>  enabled               = true</span>
<span id="cb19-29"><a href="#cb19-29"></a>  allow_mode_switch     = true</span>
<span id="cb19-30"><a href="#cb19-30"></a>  allow_updates         = true</span>
<span id="cb19-31"><a href="#cb19-31"></a>  allowed_to_leave      = true</span>
<span id="cb19-32"><a href="#cb19-32"></a>  auto_connect          = 0</span>
<span id="cb19-33"><a href="#cb19-33"></a>  captive_portal        = 180</span>
<span id="cb19-34"><a href="#cb19-34"></a>  disable_auto_fallback = false</span>
<span id="cb19-35"><a href="#cb19-35"></a>  switch_locked         = false</span>
<span id="cb19-36"><a href="#cb19-36"></a>  service_mode_v2_mode  = "warp"</span>
<span id="cb19-37"><a href="#cb19-37"></a>  service_mode_v2_port  = 3000</span>
<span id="cb19-38"><a href="#cb19-38"></a>  exclude_office_ips    = true</span>
<span id="cb19-39"><a href="#cb19-39"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div style="page-break-after: always;"></div>
</section>
</section>
</section>
<section id="cloudflare-tunnel" class="level4">
<h4 class="anchored" data-anchor-id="cloudflare-tunnel">Cloudflare Tunnel</h4>
<p>Tunnels are used to exposed private applications or for connectivity in the case of RDP, SSH, VNC and the like, it does not support bi-directional traffic as mentioned above. By setting up the routes, you can now reach those same private applications behind Cloudflare Tunnel be it from a PAC file, clientless RBI, WARP or behind Magic WAN.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Cloudflare Tunnel Deployment</strong></p>
<p>There are (again) like WARP many ways to deploy, as systemd on a VM or metal, docker standalone or in compose or a deployment in k8s or docker swarm.</p>
<p>Be aware of the system requirements:</p>
<p>For most use cases, we recommend the following baseline configuration:</p>
<ul>
<li>Run a cloudflared replica on two dedicated host machines per network location. Using two hosts enables server-side redundancy and traffic balancing.</li>
<li>Size each host with minimum 4GB of RAM and 4 CPU cores.</li>
<li>Allocate 50,000 ports to the cloudflared process on each host.</li>
</ul>
<p>This setup is usually sufficient to handle traffic from 8,000 WARP users (4,000 per host). The actual amount of resources used by cloudflared will depend on many variables, including the number of requests per second, bandwidth, network path and hardware. As additional users are onboarded, or if network traffic increases beyond your existing tunnel capacity, you can scale your tunnel by adding an additional cloudflared host in that location.</p>
</div>
</div>
<div style="page-break-after: always;"></div>
<section id="gitopsiac-2" class="level5">
<h5 class="anchored" data-anchor-id="gitopsiac-2">Gitops/IaC</h5>
<section id="terraform-provider-hcl-with-random-provider" class="level6">
<h6 class="anchored" data-anchor-id="terraform-provider-hcl-with-random-provider">Terraform provider HCL with random provider</h6>
<div class="sourceCode" id="cb20"><pre class="sourceCode numberSource terraform number-lines code-with-copy"><code class="sourceCode"><span id="cb20-1"><a href="#cb20-1"></a>terraform {</span>
<span id="cb20-2"><a href="#cb20-2"></a>  required_providers {</span>
<span id="cb20-3"><a href="#cb20-3"></a>    cloudflare = {</span>
<span id="cb20-4"><a href="#cb20-4"></a>      source  = "cloudflare/cloudflare"</span>
<span id="cb20-5"><a href="#cb20-5"></a>      version = "~&gt; 4.0"</span>
<span id="cb20-6"><a href="#cb20-6"></a>    }</span>
<span id="cb20-7"><a href="#cb20-7"></a>    random = {</span>
<span id="cb20-8"><a href="#cb20-8"></a>      source  = "hashicorp/random"</span>
<span id="cb20-9"><a href="#cb20-9"></a>      version = "~&gt; 3.0"</span>
<span id="cb20-10"><a href="#cb20-10"></a>    }</span>
<span id="cb20-11"><a href="#cb20-11"></a>  }</span>
<span id="cb20-12"><a href="#cb20-12"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="use-the-random-provider-to-generate-string-that-will-be-use-to-set-the-tunnel-secret" class="level6">
<h6 class="anchored" data-anchor-id="use-the-random-provider-to-generate-string-that-will-be-use-to-set-the-tunnel-secret">Use the random provider to generate string that will be use to set the tunnel secret</h6>
<div class="sourceCode" id="cb21"><pre class="sourceCode numberSource terraform number-lines code-with-copy"><code class="sourceCode"><span id="cb21-1"><a href="#cb21-1"></a># Generate a random string</span>
<span id="cb21-2"><a href="#cb21-2"></a>resource "random_string" "tunnel_secret" {</span>
<span id="cb21-3"><a href="#cb21-3"></a>  length  = 32</span>
<span id="cb21-4"><a href="#cb21-4"></a>  special = false</span>
<span id="cb21-5"><a href="#cb21-5"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="use-the-random-string-as-the-tunnel-secret-to-create-the-cloudflare-tunnel" class="level6">
<h6 class="anchored" data-anchor-id="use-the-random-string-as-the-tunnel-secret-to-create-the-cloudflare-tunnel">Use the random string as the tunnel secret to create the Cloudflare Tunnel</h6>
<div class="sourceCode" id="cb22"><pre class="sourceCode numberSource terraform number-lines code-with-copy"><code class="sourceCode"><span id="cb22-1"><a href="#cb22-1"></a>resource "cloudflare_tunnel" "vyos_nl" {</span>
<span id="cb22-2"><a href="#cb22-2"></a>  account_id = var.cloudflare_account_id</span>
<span id="cb22-3"><a href="#cb22-3"></a>  name       = "vyos_nl"</span>
<span id="cb22-4"><a href="#cb22-4"></a>  secret     = base64encode(random_string.tunnel_secret.result)</span>
<span id="cb22-5"><a href="#cb22-5"></a>  config_src = "cloudflare"</span>
<span id="cb22-6"><a href="#cb22-6"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div style="page-break-after: always;"></div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Again, be aware of conflicting routes between Cloudflare Tunnel and Magic WAN</p>
</div>
</div>
</section>
<section id="tunnel-route-hcl" class="level6">
<h6 class="anchored" data-anchor-id="tunnel-route-hcl">Tunnel Route HCL</h6>
<div class="sourceCode" id="cb23"><pre class="sourceCode numberSource terraform number-lines code-with-copy"><code class="sourceCode"><span id="cb23-1"><a href="#cb23-1"></a>resource "cloudflare_tunnel_route" "vyos_nl" {</span>
<span id="cb23-2"><a href="#cb23-2"></a>  account_id         = var.cloudflare_account_id</span>
<span id="cb23-3"><a href="#cb23-3"></a>  tunnel_id          = cloudflare_tunnel.vyos_nl.id</span>
<span id="cb23-4"><a href="#cb23-4"></a>  network            = "0.0.0.0/0"</span>
<span id="cb23-5"><a href="#cb23-5"></a>  virtual_network_id = cloudflare_tunnel_virtual_network.vyos_nl.id</span>
<span id="cb23-6"><a href="#cb23-6"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="tunnel-config-hcl" class="level6">
<h6 class="anchored" data-anchor-id="tunnel-config-hcl">Tunnel Config HCL</h6>
<div class="sourceCode" id="cb24"><pre class="sourceCode numberSource terraform number-lines code-with-copy"><code class="sourceCode"><span id="cb24-1"><a href="#cb24-1"></a>resource "cloudflare_tunnel_config" "vyos_nl" {</span>
<span id="cb24-2"><a href="#cb24-2"></a>  account_id = var.cloudflare_account_id</span>
<span id="cb24-3"><a href="#cb24-3"></a>  tunnel_id  = cloudflare_tunnel.vyos_nl.id</span>
<span id="cb24-4"><a href="#cb24-4"></a> </span>
<span id="cb24-5"><a href="#cb24-5"></a>  config {</span>
<span id="cb24-6"><a href="#cb24-6"></a>    warp_routing {</span>
<span id="cb24-7"><a href="#cb24-7"></a>      enabled = true</span>
<span id="cb24-8"><a href="#cb24-8"></a>    }</span>
<span id="cb24-9"><a href="#cb24-9"></a>    ingress_rule {</span>
<span id="cb24-10"><a href="#cb24-10"></a>      hostname = "prom-tunnel-nl.${var.domain_name}"</span>
<span id="cb24-11"><a href="#cb24-11"></a>      service  = "http://localhost:11000"</span>
<span id="cb24-12"><a href="#cb24-12"></a>    }</span>
<span id="cb24-13"><a href="#cb24-13"></a>    ingress_rule {</span>
<span id="cb24-14"><a href="#cb24-14"></a>      hostname = "prom-caddy-nl.${var.domain_name}"</span>
<span id="cb24-15"><a href="#cb24-15"></a>      service  = "http://172.18.0.4:2018"</span>
<span id="cb24-16"><a href="#cb24-16"></a>    }</span>
<span id="cb24-17"><a href="#cb24-17"></a>    ingress_rule {</span>
<span id="cb24-18"><a href="#cb24-18"></a>      service = "http_status:404"</span>
<span id="cb24-19"><a href="#cb24-19"></a>    }</span>
<span id="cb24-20"><a href="#cb24-20"></a>  }</span>
<span id="cb24-21"><a href="#cb24-21"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div style="page-break-after: always;"></div>
</section>
</section>
</section>
<section id="beta-warp-connector" class="level4">
<h4 class="anchored" data-anchor-id="beta-warp-connector">(Beta) WARP Connector</h4>
<p>It shares the same functionality as Cloudflare Tunnel does but with bidirectional support. This means that only you can expose private services/applications which require two-way traffic such as communication services.</p>
<p>As the WARP connector is also essentially a device connected via WARP to the internet, a remote user with WARP connectivity can also connect to it directly and not just the services exposed behind it which is what we call WARP-to-WARP connectivity. Both site-to-site and peer-to-peer use cases work here, similar to Magic WAN.</p>
<section id="site-to-site-connectivity" class="level5">
<h5 class="anchored" data-anchor-id="site-to-site-connectivity">Site-to-site Connectivity</h5>
<ol type="1">
<li>Setup Access policy for WARP enrolment (this would be the same policy for WARP authentication), since it’s site-to-site, we will have to deploy it via <code>.xml</code> with the required parameters.</li>
</ol>
<p>Refer to <a href="https://developers.cloudflare.com/cloudflare-one/identity/service-tokens/">service tokens</a> and <a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-devices/warp/deployment/device-enrollment/">device enrolment</a> for details.</p>
<ol start="2" type="1">
<li>Setup the <code>split tunnel</code> to either <code>include</code> or <code>exclude</code> mode, in this example, I have chosen <code>exclude</code> so that I can still SSH into the nodes to showcase the functionality.</li>
</ol>
<p>Since this portion can be managed by Terraform, this is the example HCL:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode numberSource terraform number-lines code-with-copy"><code class="sourceCode"><span id="cb25-1"><a href="#cb25-1"></a>resource "cloudflare_split_tunnel" "default_include" {</span>
<span id="cb25-2"><a href="#cb25-2"></a>  account_id = var.cloudflare_account_id</span>
<span id="cb25-3"><a href="#cb25-3"></a>  policy_id  = cloudflare_device_settings_policy.default.id</span>
<span id="cb25-4"><a href="#cb25-4"></a>  mode       = "exclude"</span>
<span id="cb25-5"><a href="#cb25-5"></a>  tunnels {</span>
<span id="cb25-6"><a href="#cb25-6"></a>    address     = "10.68.69.3"</span>
<span id="cb25-7"><a href="#cb25-7"></a>    description = "ERFI1"</span>
<span id="cb25-8"><a href="#cb25-8"></a>  }</span>
<span id="cb25-9"><a href="#cb25-9"></a>  tunnels {</span>
<span id="cb25-10"><a href="#cb25-10"></a>    address     = "10.68.73.3"</span>
<span id="cb25-11"><a href="#cb25-11"></a>    description = "arch-0"</span>
<span id="cb25-12"><a href="#cb25-12"></a>  }</span>
<span id="cb25-13"><a href="#cb25-13"></a>  tunnels {</span>
<span id="cb25-14"><a href="#cb25-14"></a>    address     = "10.68.73.2"</span>
<span id="cb25-15"><a href="#cb25-15"></a>    description = "pve"</span>
<span id="cb25-16"><a href="#cb25-16"></a>  }</span>
<span id="cb25-17"><a href="#cb25-17"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div style="page-break-after: always;"></div>
<ol start="3" type="1">
<li>Ensure these settings are enabled:</li>
</ol>
<ul>
<li>Enable CGNAT routing (Settings -&gt; Network)
<ul>
<li>Enable Proxy (UDP, TCP, ICMP)</li>
<li>Enable WARP to WARP</li>
<li>Override local interface IP (Settings -&gt; WARP Client)
<ul>
<li>If in <code>include</code> mode, ensure <code>100.96.0.0/12</code> is included</li>
</ul></li>
</ul></li>
</ul>
<p>Some of these settings are available as a Terraform resource (as shown below), since it would be a mix a of API/UI and Terraform, Terraform would not know the state, so just keep to API/UI for all settings.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode numberSource terraform number-lines code-with-copy"><code class="sourceCode"><span id="cb26-1"><a href="#cb26-1"></a>resource "cloudflare_teams_account" "miau3" {</span>
<span id="cb26-2"><a href="#cb26-2"></a>  account_id                             = var.cloudflare_account_id</span>
<span id="cb26-3"><a href="#cb26-3"></a>  tls_decrypt_enabled                    = false</span>
<span id="cb26-4"><a href="#cb26-4"></a>  protocol_detection_enabled             = false</span>
<span id="cb26-5"><a href="#cb26-5"></a>  activity_log_enabled                   = true</span>
<span id="cb26-6"><a href="#cb26-6"></a>  non_identity_browser_isolation_enabled = true</span>
<span id="cb26-7"><a href="#cb26-7"></a></span>
<span id="cb26-8"><a href="#cb26-8"></a>  body_scanning {</span>
<span id="cb26-9"><a href="#cb26-9"></a>    inspection_mode = "deep"</span>
<span id="cb26-10"><a href="#cb26-10"></a>  }</span>
<span id="cb26-11"><a href="#cb26-11"></a></span>
<span id="cb26-12"><a href="#cb26-12"></a>  antivirus {</span>
<span id="cb26-13"><a href="#cb26-13"></a>    enabled_download_phase = false</span>
<span id="cb26-14"><a href="#cb26-14"></a>    enabled_upload_phase   = false</span>
<span id="cb26-15"><a href="#cb26-15"></a>    fail_closed            = false</span>
<span id="cb26-16"><a href="#cb26-16"></a>  }</span>
<span id="cb26-17"><a href="#cb26-17"></a></span>
<span id="cb26-18"><a href="#cb26-18"></a>  fips {</span>
<span id="cb26-19"><a href="#cb26-19"></a>    tls = false</span>
<span id="cb26-20"><a href="#cb26-20"></a>  }</span>
<span id="cb26-21"><a href="#cb26-21"></a></span>
<span id="cb26-22"><a href="#cb26-22"></a>  proxy {</span>
<span id="cb26-23"><a href="#cb26-23"></a>    tcp     = true</span>
<span id="cb26-24"><a href="#cb26-24"></a>    udp     = true</span>
<span id="cb26-25"><a href="#cb26-25"></a>    root_ca = true</span>
<span id="cb26-26"><a href="#cb26-26"></a>  }</span>
<span id="cb26-27"><a href="#cb26-27"></a></span>
<span id="cb26-28"><a href="#cb26-28"></a>  url_browser_isolation_enabled = true</span>
<span id="cb26-29"><a href="#cb26-29"></a></span>
<span id="cb26-30"><a href="#cb26-30"></a>  logging {</span>
<span id="cb26-31"><a href="#cb26-31"></a>    redact_pii = false</span>
<span id="cb26-32"><a href="#cb26-32"></a>    settings_by_rule_type {</span>
<span id="cb26-33"><a href="#cb26-33"></a>      dns {</span>
<span id="cb26-34"><a href="#cb26-34"></a>        log_all    = true</span>
<span id="cb26-35"><a href="#cb26-35"></a>        log_blocks = false</span>
<span id="cb26-36"><a href="#cb26-36"></a>      }</span>
<span id="cb26-37"><a href="#cb26-37"></a>      http {</span>
<span id="cb26-38"><a href="#cb26-38"></a>        log_all    = true</span>
<span id="cb26-39"><a href="#cb26-39"></a>        log_blocks = false</span>
<span id="cb26-40"><a href="#cb26-40"></a>      }</span>
<span id="cb26-41"><a href="#cb26-41"></a>      l4 {</span>
<span id="cb26-42"><a href="#cb26-42"></a>        log_all    = true</span>
<span id="cb26-43"><a href="#cb26-43"></a>        log_blocks = false</span>
<span id="cb26-44"><a href="#cb26-44"></a>      }</span>
<span id="cb26-45"><a href="#cb26-45"></a>    }</span>
<span id="cb26-46"><a href="#cb26-46"></a>  }</span>
<span id="cb26-47"><a href="#cb26-47"></a></span>
<span id="cb26-48"><a href="#cb26-48"></a>  extended_email_matching {</span>
<span id="cb26-49"><a href="#cb26-49"></a>    enabled = true</span>
<span id="cb26-50"><a href="#cb26-50"></a>  }</span>
<span id="cb26-51"><a href="#cb26-51"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="4" type="1">
<li>Set up the WARP Connector</li>
</ol>
<ul>
<li>Either via API or the UI, create the WARP connector (currently not available as a Terraform resource):</li>
</ul>
<div class="sourceCode" id="cb27"><pre class="sourceCode numberSource curl number-lines code-with-copy"><code class="sourceCode"><span id="cb27-1"><a href="#cb27-1"></a>curl --request POST \</span>
<span id="cb27-2"><a href="#cb27-2"></a>  --url https://api.cloudflare.com/client/v4/accounts/account_id/warp_connector \</span>
<span id="cb27-3"><a href="#cb27-3"></a>  --header 'Content-Type: application/json' \</span>
<span id="cb27-4"><a href="#cb27-4"></a>  --header 'X-Auth-Email: ' \</span>
<span id="cb27-5"><a href="#cb27-5"></a>  --data '{</span>
<span id="cb27-6"><a href="#cb27-6"></a>  "name": "arch-0"</span>
<span id="cb27-7"><a href="#cb27-7"></a>}'</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Upon creation, you will get the example <code>.xml</code> e.g.&nbsp;which will look like this:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode numberSource xml number-lines code-with-copy"><code class="sourceCode xml"><span id="cb28-1"><a href="#cb28-1"></a>&lt;<span class="kw">dict</span>&gt;</span>
<span id="cb28-2"><a href="#cb28-2"></a> &lt;<span class="kw">key</span>&gt;organization&lt;/<span class="kw">key</span>&gt;</span>
<span id="cb28-3"><a href="#cb28-3"></a> &lt;<span class="kw">string</span>&gt;org_name&lt;/<span class="kw">string</span>&gt;</span>
<span id="cb28-4"><a href="#cb28-4"></a> &lt;<span class="kw">key</span>&gt;auth_client_id&lt;/<span class="kw">key</span>&gt;</span>
<span id="cb28-5"><a href="#cb28-5"></a> &lt;<span class="kw">string</span>&gt;client_access_id_string&lt;/<span class="kw">string</span>&gt;</span>
<span id="cb28-6"><a href="#cb28-6"></a> &lt;<span class="kw">key</span>&gt;auth_client_secret&lt;/<span class="kw">key</span>&gt;</span>
<span id="cb28-7"><a href="#cb28-7"></a> &lt;<span class="kw">string</span>&gt;client_access_secret_string&lt;/<span class="kw">string</span>&gt;</span>
<span id="cb28-8"><a href="#cb28-8"></a> &lt;<span class="kw">key</span>&gt;warp_connector_token&lt;/<span class="kw">key</span>&gt;</span>
<span id="cb28-9"><a href="#cb28-9"></a> &lt;<span class="kw">string</span>&gt;connector_token_string&lt;/<span class="kw">string</span>&gt;</span>
<span id="cb28-10"><a href="#cb28-10"></a>&lt;/<span class="kw">dict</span>&gt;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This is what you will place in the <code>/var/lib/cloudflare-warp</code> directory after the WARP client install. Refer to the relevant <a href="https://pkg.cloudflareclient.com/">repositories</a> that matches your Linux distribution, for Arch, you would have to install via <a href="https://aur.archlinux.org/packages/cloudflare-warp-bin">AUR</a>.</p>
<p>Once done, if not yet enabled, run <code>sudo systemctl enable warp-svc</code> then <code>sudo systemctl start warp-svc</code>, if already running as a service, run <code>sudo systemctl restart warp-svc</code> so that it will use the new configuration to connect to Cloudflare.</p>
<div style="page-break-after: always;"></div>
<ol start="5" type="1">
<li>Set up Linux networking</li>
</ol>
<p>We need to enable IP forwarding and MSS clamping (WARP’s MTU is 1280 bytes).</p>
<p>Create a <code>.conf</code> file in the <code>etc/sysctl.d/</code> directory with value of <code>net.ipv4.ip_forward = 1</code> so that this persists upon reboot.</p>
<p>To check what IPtables rules are existing, we can run <code>sudo iptables-save &gt; test.conf</code> to just see what’s currently being use, if all’s well. We can add the following to the existing <code>/etc/iptables/iptables.rules</code> file, such that it would look something like this:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1"></a><span class="ex">*filter</span></span>
<span id="cb29-2"><a href="#cb29-2"></a><span class="ex">:INPUT</span> ACCEPT <span class="pp">[</span><span class="ss">0:0</span><span class="pp">]</span></span>
<span id="cb29-3"><a href="#cb29-3"></a><span class="ex">:FORWARD</span> ACCEPT <span class="pp">[</span><span class="ss">0:0</span><span class="pp">]</span></span>
<span id="cb29-4"><a href="#cb29-4"></a><span class="ex">:OUTPUT</span> ACCEPT <span class="pp">[</span><span class="ss">0:0</span><span class="pp">]</span></span>
<span id="cb29-5"><a href="#cb29-5"></a><span class="ex">-A</span> FORWARD <span class="at">-i</span> CloudflareWARP <span class="at">-p</span> tcp <span class="at">-m</span> tcp <span class="at">--tcp-flags</span> SYN,RST SYN <span class="at">-j</span> TCPMSS <span class="at">--clamp-mss-to-pmtu</span></span>
<span id="cb29-6"><a href="#cb29-6"></a><span class="ex">-A</span> FORWARD <span class="at">-o</span> CloudflareWARP <span class="at">-p</span> tcp <span class="at">-m</span> tcp <span class="at">--tcp-flags</span> SYN,RST SYN <span class="at">-j</span> TCPMSS <span class="at">--clamp-mss-to-pmtu</span></span>
<span id="cb29-7"><a href="#cb29-7"></a><span class="ex">COMMIT</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This would make sure the MSS clamping rules will also persist on reboot.</p>
<div style="page-break-after: always;"></div>
<ol start="6" type="1">
<li>Route nodes/VMs/containers to the WARP connector</li>
</ol>
<p>The most common use case here would either be an alternate gateway to the main router or an intermediate gateway. In this example, I will be using it as an intermediate gateway.</p>
<p>Set up the <code>static routes</code> for each WARP connector, the configuration will be similar to the <code>Cloudflare Tunnel</code> routes. In our case, on the WARP connector called <code>arch-1</code>, we will exposing <code>10.68.73.102/32</code> for the <code>arch-2</code> machine, and <code>arch-3</code> will be exposing <code>10.68.73.104/32</code> for <code>arch-4</code> machine.</p>
<p>Let’s use <code>arch-2</code> as an example as the same steps will be replicated on the other node.</p>
<p>Run:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1"></a><span class="ex">ip</span> route</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and you should be able to see default routes, for instance:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1"></a><span class="ex">default</span> via 10.68.73.1 dev ens18 proto dhcp src 10.68.73.102 metric 100</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>we want to create another route that has higher precedence than this (lower number).</p>
<p>Run:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1"></a><span class="fu">sudo</span> ip route add default via 10.68.73.101 dev ens18 metric 99</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>What this means is that, traffic from <code>arch-2</code> will go via the <code>ens18</code> interface to <code>10.68.73.101</code> which is the WARP connector <code>arch-1</code> and using it as a gateway, now this node is connected to Cloudflare.</p>
<p>Do the same for the other node, and change the IP.</p>
<p>Run:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1"></a><span class="ex">curl</span> https://icanhazip.com</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>on either machine, and you should be able to see a Cloudflare IP, just be aware since all traffic is sent to the WARP connector, that the DNS server used by the machines routed to WARP connector can be accessed while on the network, either by another route or a public DNS server.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1"></a><span class="ex">curl</span> icanhazip.com                                                              </span>
<span id="cb34-2"><a href="#cb34-2"></a><span class="ex">104.28.218.39</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="7" type="1">
<li>Route the machines to each other</li>
</ol>
<p>We can either router the entire prefix to the WARP connector or specific IPs, in my case, I will be using just one IP:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1"></a><span class="fu">sudo</span> ip route add 10.68.73.104 via 10.68.73.101 dev ens18 metric 98</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This will allow <code>10.68.73.102</code> to reach <code>10.68.73.104</code>, do the same on <code>arch-4</code>, just by swapping the IPs, from <code>.104</code> to <code>.102</code></p>
<p>Run:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb36-1"><a href="#cb36-1"></a><span class="fu">ping</span> 10.68.73.102</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>or</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1"></a><span class="ex">mtr</span> 10.68.73.102</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and vice versa to see the traffic reach the WARP connector CGNAT IP before reaching the other machine.</p>
</section>
</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>The arrows signify bidirectional connections or unidirectional<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by/ND/">CC BY ND</a></div></div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>